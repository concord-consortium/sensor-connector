<?xml version="1.0" encoding="UTF-8"?>
<project name="SensorServer" default="build" basedir="." xmlns:fx="javafx:com.sun.javafx.tools.ant">

  <property environment="env" />
  <condition property="certname" value="${env.CERT_NAME}">
    <isset property="env.CERT_NAME" />
  </condition>
  <condition property="certname" value="Developer ID Application: Concord Consortium Inc (T8HS8WBPPQ)">
    <and>
      <os family="mac" />
      <not>
        <isset property="certname" />
      </not>
    </and>
  </condition>
  <condition property="certname" value="Concord Consortium">
    <and>
      <os family="windows" />
      <not>
        <isset property="certname" />
      </not>
    </and>
  </condition>

  <taskdef name="bundleapp" classname="com.oracle.appbundler.AppBundlerTask" classpath="lib/appbundler-1.0ea.jar" />
  <taskdef resource="com/sun/javafx/tools/ant/antlib.xml" uri="javafx:com.sun.javafx.tools.ant" classpath=".:lib/ant-javafx.jar" />

  <target name="clean">
    <delete removeNotFollowedSymlinks="true" followSymlinks="false" includeEmptyDirs="true" failonerror="false">
      <fileset dir="dist" />
    </delete>
  </target>

  <target name="prep" depends="clean">
    <mkdir dir="dist" />
    <mkdir dir="dist/app" />
    <mkdir dir="dist/app/.background" />
  </target>

  <target name="build" depends="prep">
    <exec executable="mvn.bat" failonerror="true" osfamily="windows">
      <arg value="-U" />
      <arg value='-DexcludeClassifiers="linux-x86,linux-x86_64,linux-arm,windows-x86_64,osx-x86,osx-x86_64"' />
      <arg value="clean" />
      <arg value="package" />
      <arg value="dependency:copy-dependencies" />
    </exec>
    <exec executable="mvn" failonerror="true" osfamily="mac">
      <arg value="-U" />
      <arg value='-DexcludeClassifiers="linux-x86,linux-x86_64,linux-arm,windows-x86,windows-x86_64,osx-x86_64"' />
      <arg value="clean" />
      <arg value="package" />
      <arg value="dependency:copy-dependencies" />
    </exec>
  </target>

  <target name="fx-package" depends="build">
    <fail unless="env.JAVA_HOME" message="You must set JAVA_HOME (eg: 'export JAVA_HOME=`/usr/libexec/java_home`')" />
    <copy file="target/sensor-server-0.0.1-SNAPSHOT.jar" todir="target/dependency" />
    <fx:deploy verbose="true" nativeBundles="all" width="100" height="100" outdir="dist/" outfile="SensorServer">
      <info title="Sensor Server" vendor="Concord Consortium" description="Sensor Server Application" />
      <fx:application mainClass="org.concord.sensor.server.SensorServer" toolkit="swing"/>
      <fx:resources>
        <fx:fileset dir="target/dependency">
          <include name="**/*.jar" />
        </fx:fileset>
        <fx:fileset dir="${env.JAVA_HOME}/jre/bin">
          <include name="msvcr100.dll" />
        </fx:fileset>
      </fx:resources>
    </fx:deploy>
    <exec executable="signtool.exe" dir="dist/bundles" failonerror="false">
      <arg line="sign /n '${certname}' /tr http://tsa.starfieldtech.com /td SHA256 /v SensorServer-1.0.msi" />
    </exec>
  </target>

  <target name="mac-stage" depends="build">
    <fail unless="env.JRE_HOME" message="You must set JRE_HOME (eg: 'export JRE_HOME=/System/Library/Frameworks/JavaVM.framework/Versions/CurrentJDK')" />
    <copy file="resources/bg.png" todir="dist/app/.background" />
    <mkdir dir="dist/app/SensorServer.app" />
    <mkdir dir="dist/app/SensorServer.app/Contents" />
    <mkdir dir="dist/app/SensorServer.app/Contents/MacOS" />
    <mkdir dir="dist/app/SensorServer.app/Contents/Resources" />
    <mkdir dir="dist/app/SensorServer.app/Contents/Java" />
    <copy file="resources/cc-lightbulb.icns" todir="dist/app/SensorServer.app/Contents/Resources" />
    <copy file="resources/Info.plist" todir="dist/app/SensorServer.app/Contents" />
    <copy file="resources/run.sh" todir="dist/app/SensorServer.app/Contents/MacOS" />
    <chmod perm="a+x" file="dist/app/SensorServer.app/Contents/MacOS/run.sh" />
    <copy todir="dist/app/SensorServer.app/Contents/Java" flatten="true">
      <fileset dir="target">
        <include name="**/*.jar" />
      </fileset>
    </copy>
    <exec executable="cp" dir="dist/app/SensorServer.app/Contents/Resources">
      <arg line="-r ${env.JRE_HOME} jdk" />
    </exec>
    <exec executable="bash" dir="dist/app/SensorServer.app/Contents/Resources/jdk/Home">
      <arg line='-c "ln -s ../ bundle"' />
    </exec>
  </target>

  <target name="mac-sign">
    <exec executable="codesign" failonerror="false">
      <arg value="-f" />
      <arg value="--deep" />
      <arg value="-s" />
      <arg value="${certname}" />
      <arg value="dist/app/SensorServer.app" />
    </exec>
  </target>

  <target name="mac-package" depends="prep,build,mac-stage,mac-sign">
    <exec executable="./script/create_dmg.sh" />
    <exec executable="codesign" failonerror="false">
      <arg value="-f" />
      <arg value="-s" />
      <arg value="${certname}" />
      <arg value="dist/sensor_server_installer.dmg" />
    </exec>
  </target>


</project>
